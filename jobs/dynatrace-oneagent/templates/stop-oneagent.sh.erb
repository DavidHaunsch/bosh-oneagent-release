#!/bin/bash

export START_HELPER="<%= properties.dynatrace.starthelper %>"

INSTALL_DIR="/var/vcap/data/dynatrace/oneagent"

installLog() {
    echo "$1" | tee -a "${LOG_FILE}"
}

stopOneAgentHelper() {
  if pgrep -x "oneagenthelper" > /dev/null
  then
    installLog "Stopping oneagenthelper..."
    pkill -x oneagenthelper
    installLog "Done"
  fi
}

uninstallOneAgent() {
    installLog "Trying to uninstall the OneAgent..."

    local agentDir="${INSTALL_DIR}"
    local leftoverSymlink="/opt/dynatrace/oneagent"

    if [[ ! -d "${agentDir}" ]]; then
        # fallback to cover previous versions of addon
        agentDir="/opt/dynatrace/oneagent"
    fi

    if [[ "$START_HELPER" != "0" ]]; then
        stopOneAgentHelper
    fi

    if [[ -f "${agentDir}/agent/uninstall.sh" ]]; then
        installLog "Found uninstall script to run..."
        sh "${agentDir}/agent/uninstall.sh" 2>&1 | tee -a "${LOG_FILE}"
    fi

    installLog "Cleaning up ${agentDir}..."
    rm -rf ${agentDir}
    #/var/lib/dynatrace
    #/var/log/dynatrace

    if [[ -L "${leftoverSymlink}" ]] && [[ ! -e "${leftoverSymlink}" ]]; then
        installLog "Removing broken symlink ${leftoverSymlink}"
        rm "${leftoverSymlink}"
    fi
}

uninstallOneAgent
