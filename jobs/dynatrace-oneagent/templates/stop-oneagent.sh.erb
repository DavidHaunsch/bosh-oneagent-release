#!/bin/bash

INSTALL_DIR="/var/vcap/data/dynatrace/oneagent"

installLog() {
    echo "$1" | tee -a "${LOG_FILE}"
}

uninstallOneAgent() {
    installLog "Trying to uninstall the OneAgent..."

    local agentDir="${INSTALL_DIR}"
    local leftoverSymlink="/opt/dynatrace/oneagent"
    local dynatraceLibDir="/var/lib/dynatrace"
    local dynatraceLogDir="/var/vcap/data/sys/log/dynatrace-oneagent"

    if [[ ! -d "${agentDir}" ]]; then
        # fallback to cover previous versions of addon
        agentDir="/opt/dynatrace/oneagent"
    fi

    if [[ -f "${agentDir}/agent/uninstall.sh" ]]; then
        installLog "Found uninstall script to run..."
        sh "${agentDir}/agent/uninstall.sh" 2>&1 | tee -a "${LOG_FILE}"
    fi

    installLog "Cleaning up ${agentDir}..."
    rm -rf ${agentDir}
    if [[ -d "${dynatraceLibDir}" ]]; then
        rm -rf "${dynatraceLibDir}"
    fi
    if [[ -d "${dynatraceLogDir}" ]]; then
        rm -rf "${dynatraceLogDir}"
    fi

    if [[ -L "${leftoverSymlink}" ]] && [[ ! -e "${leftoverSymlink}" ]]; then
        installLog "Removing broken symlink ${leftoverSymlink}"
        rm "${leftoverSymlink}"
    fi
}

uninstallOneAgent
