#!/bin/bash
set -e -x

export PATH="/var/vcap/packages/dynatrace-oneagent:$PATH"
export START_HELPER="<%= properties.dynatrace.starthelper %>"

export TMPDIR=/var/vcap/data/tmp

RUN_DIR=/var/vcap/sys/run/dynatrace-oneagent
export LOG_DIR=/var/vcap/sys/log/dynatrace-oneagent
export LOG_FILE=$LOG_DIR/dynatrace-oneagenthelper-job.log
PID_FILE=${RUN_DIR}/dynatrace-oneagenthelper.pid
mkdir -p ${RUN_DIR} ${LOG_DIR}

# Source helper functions
source /var/vcap/jobs/dynatrace-oneagent/bin/common.sh

getOneAgentHelperPid() {
  pgrep -x oneagenthelper
}

startOneAgentHelper() {
  #gdn is the daemon for garden-runc >= 1.2.0
  if pgrep -x "gdn" > /dev/null
  then
    toLogInfo "Found gdn process. Starting oneagenthelper..."
    /opt/dynatrace/oneagent/agent/lib64/oneagenthelper -p `pgrep -x gdn` --garden &
  fi

  #guardian is the daemon for garden-runc < 1.2.0
  if pgrep -x "guardian" > /dev/null
  then
    toLogInfo "Found guardian process. Starting oneagenthelper..."
    /opt/dynatrace/oneagent/agent/lib64/oneagenthelper -p `pgrep -x guardian` --garden &
  fi
}

stopOneAgentHelper() {
  if pgrep -x "oneagenthelper" > /dev/null
  then
    toLogInfo "Stopping oneagenthelper..."
    pkill -x oneagenthelper  >> $LOG_FILE 2>> $LOG_FILE
  fi
  rm ${PID_FILE}
}

isDiegoCell(){
  grep diego_cell /var/vcap/bosh/spec.json | wc -l
}

toLogInfo "dynatrace-oneagenthelper.sh $1" 
toLogInfo "START_HELPER: $START_HELPER"

case $1 in
  start)
    # Start oneagenthelper if START_HELPER was set
    # Check if agent runs on a diego_cell
    isDiego=$(isDiegoCell)
    if [ $isDiego == 1 -a "x$START_HELPER" != "x0" ]; then
      toLogInfo "Diego cell detected, starthelper enabled, starting oneagenthelper..."
      startOneAgentHelper
      pid=$(getOneAgentHelperPid)
      echo $pid > ${PID_FILE}
    else
      toLogInfo "No garden detected OR starthelper disabled, so no need to run oneagenthelper"
      toLogInfo "Pretending oneagenthelper is running to fool monit checks"
      echo `cat ${RUN_DIR}/dynatrace-watchdog.pid` > ${PID_FILE}
    fi
    ;;

  stop)
    stopOneAgentHelper
    ;;
    
esac
